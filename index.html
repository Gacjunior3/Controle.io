<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhamento de Entregas</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-coletando: #0077b6;
            --color-transito: #ffaa00;
            --color-parado: #dc3545;
            --color-entregue: #28a745;
            --color-primary: #007bff;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-secondary: #6c757d;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --color-white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: flex-end;
            background-color: var(--color-white);
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
            flex-grow: 1;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            font-size: 14px;
            background-color: var(--color-white);
            box-shadow: var(--shadow-sm);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: #f1f5f9;
            position: sticky;
            top: 0;
            font-weight: 600;
            color: #2c3e50;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: #f1f5f9;
            transition: var(--transition);
        }
        
        /* Status Styles - More Vibrant */
        .status-coletando {
            background-color: rgba(0, 119, 182, 0.15);
            color: var(--color-coletando);
            font-weight: 600;
            border-left: 4px solid var(--color-coletando);
        }
        
        .status-transito {
            background-color: rgba(255, 170, 0, 0.15);
            color: var(--color-transito);
            font-weight: 600;
            border-left: 4px solid var(--color-transito);
        }
        
        .status-parado {
            background-color: rgba(220, 53, 69, 0.15);
            color: var(--color-parado);
            font-weight: 600;
            border-left: 4px solid var(--color-parado);
        }
        
        .status-entregue {
            background-color: rgba(40, 167, 69, 0.15);
            color: var(--color-entregue);
            font-weight: 600;
            border-left: 4px solid var(--color-entregue);
        }
        
        .whatsapp-number {
            color: #25D366;
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            transition: var(--transition);
        }
        
        .whatsapp-number:hover {
            background-color: rgba(37, 211, 102, 0.1);
            text-decoration: none;
        }
        
        .action-btn {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin: 2px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            font-weight: 500;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .add-btn {
            background-color: var(--color-success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            min-width: 150px;
        }
        
        .add-btn:hover {
            background-color: #218838;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .reset-btn {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            min-width: 150px;
        }
        
        .reset-btn:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .export-btn {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            min-width: 150px;
            font-weight: 600;
        }
        
        .export-btn:hover {
            background-color: #5a32a3;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            transition: var(--transition);
            font-size: 14px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            color: #4a5568;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .required-field::after {
            content: " *";
            color: var(--color-danger);
        }
        
        .delete-btn {
            background-color: var(--color-danger);
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .cancel-btn {
            background-color: var(--color-warning);
            color: #212529;
        }
        
        .cancel-btn:hover {
            background-color: #e0a800;
        }
        
        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--color-success);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            display: none;
            z-index: 1000;
            font-weight: 500;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .date-input {
            max-width: 150px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                width: 100%;
            }
            
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .add-btn, .reset-btn, .export-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="copy-notification" id="copyNotification">N√∫mero copiado!</div>
    
    <h1>üì¶ Acompanhamento de Entregas</h1>
    
    <div class="controls">
        <div class="filter-group">
            <label for="searchInput">üîç Pesquisa Geral</label>
            <input type="text" id="searchInput" placeholder="Digite para filtrar...">
        </div>
        
        <div class="filter-group">
            <label for="statusFilter">üîÑ Status</label>
            <select id="statusFilter">
                <option value="">Todos</option>
                <option value="coletando">Coletando</option>
                <option value="transito">Em tr√¢nsito</option>
                <option value="parado">Parado</option>
                <option value="entregue">Entregue</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="driverFilter">üöö Motorista</label>
            <select id="driverFilter">
                <option value="">Todos</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="collaboratorFilter">üë• Colaborador</label>
            <select id="collaboratorFilter">
                <option value="">Todos</option>
                <option value="MARCIA">MARCIA</option>
                <option value="MARIANE">MARIANE</option>
                <option value="JEISE">JEISE</option>
                <option value="MONICA">MONICA</option>
                <option value="MARIVAL">MARIVAL</option>
                <option value="GENIVALDO">GENIVALDO</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="monthFilter">üìÖ M√™s</label>
            <select id="monthFilter">
                <option value="all">Todos os meses</option>
            </select>
        </div>
        
        <button class="add-btn" id="addButton">‚ûï Adicionar Entrega</button>
        <button class="reset-btn" onclick="resetFilters()">üßπ Limpar Filtros</button>
        <button class="export-btn" onclick="exportToExcel()">üì§ Exportar Excel</button>
        <span id="loadingIndicator" style="display:none;"><span class="loading"></span> Salvando...</span>
    </div>
    
    <table id="deliveryTable">
        <thead>
            <tr>
                <th>Data</th>
                <th>Cliente</th>
                <th>Respons√°vel</th>
                <th>WhatsApp</th>
                <th>Motorista</th>
                <th>WhatsApp</th>
                <th>Recebedor</th>
                <th>WhatsApp</th>
                <th>Colaborador</th>
                <th>Origem</th>
                <th>Destino</th>
                <th>Valor Frete</th>
                <th>Valor Empresa</th>
                <th>Status</th>
                <th>Observa√ß√£o</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Os dados ser√£o carregados dinamicamente pelo Firebase -->
        </tbody>
    </table>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAG60_tih4qVGIlT1bs_kt-_E_77xw-XX8",
            authDomain: "acompanhamento-transportes.firebaseapp.com",
            databaseURL: "https://acompanhamento-transportes-default-rtdb.firebaseio.com",
            projectId: "acompanhamento-transportes",
            storageBucket: "acompanhamento-transportes.appspot.com",
            messagingSenderId: "471884949849",
            appId: "1:471884949849:web:8a14680219698dddc90448"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const deliveriesRef = database.ref('deliveries');

        // Vari√°veis globais
        let drivers = [];
        let collaborators = ["MARCIA", "MARIANE", "JEISE", "MONICA", "MARIVAL", "GENIVALDO"];
        let deliveries = {};
        let deliveriesByMonth = {};
        let currentMonthFilter = 'all';

        // Fun√ß√£o para exportar para Excel
        function exportToExcel() {
            // Obter os dados vis√≠veis na tabela (j√° filtrados)
            const table = document.getElementById('deliveryTable');
            const rows = Array.from(table.querySelectorAll('tbody tr')).filter(tr => tr.style.display !== 'none');
            
            if (rows.length === 0) {
                alert('Nenhum dado para exportar!');
                return;
            }
            
            // Preparar os dados para exporta√ß√£o
            const data = [];
            
            // Adicionar cabe√ßalhos
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            data.push(headers.slice(0, -1)); // Remove a coluna "A√ß√µes"
            
            // Adicionar linhas de dados
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                const rowData = cells.map(cell => {
                    // Para c√©lulas com inputs (durante edi√ß√£o)
                    if (cell.querySelector('input')) {
                        return cell.querySelector('input').value;
                    }
                    // Para c√©lulas com selects (durante edi√ß√£o)
                    if (cell.querySelector('select')) {
                        return cell.querySelector('select').value;
                    }
                    // Para c√©lulas normais
                    return cell.textContent.trim();
                });
                data.push(rowData.slice(0, -1)); // Remove a coluna "A√ß√µes"
            });
            
            // Criar uma planilha de trabalho
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Criar um livro de trabalho e adicionar a planilha
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Entregas");
            
            // Gerar o arquivo Excel e fazer o download
            const date = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `entregas_${date}.xlsx`);
        }

        // Fun√ß√£o para mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'inline-block' : 'none';
        }

        // Fun√ß√£o para mostrar notifica√ß√£o de c√≥pia
        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // Fun√ß√£o para formatar data
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            // Ajuste para o fuso hor√°rio brasileiro
            const adjustedDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
            return adjustedDate.toLocaleDateString('pt-BR');
        }

        // Fun√ß√£o para extrair o m√™s/ano da data
        function getMonthYear(timestamp) {
            if (!timestamp) return null;
            const date = new Date(timestamp);
            // Ajuste para o fuso hor√°rio brasileiro
            const adjustedDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
            const month = adjustedDate.getMonth() + 1; // Janeiro √© 0
            const year = adjustedDate.getFullYear();
            return `${year}-${month.toString().padStart(2, '0')}`;
        }

        // Fun√ß√£o para obter o nome do m√™s
        function getMonthName(monthYear) {
            if (!monthYear) return 'Sem data';
            const [year, month] = monthYear.split('-');
            const date = new Date(year, month-1, 1);
            return date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
        }

        // Fun√ß√£o para atualizar os filtros de m√™s
        function updateMonthFilters() {
            const monthFilter = document.getElementById('monthFilter');
            
            // Limpa o dropdown mantendo apenas a op√ß√£o padr√£o
            monthFilter.innerHTML = '<option value="all">Todos os meses</option>';
            
            // Obt√©m o m√™s atual corretamente
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            
            // Cria um conjunto de todos os meses presentes nos dados + √∫ltimos 12 meses
            const allMonths = new Set();
            
            // Adiciona meses existentes nos dados
            Object.keys(deliveriesByMonth).forEach(month => {
                if (month) allMonths.add(month);
            });
            
            // Garante que os √∫ltimos 12 meses estejam na lista
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const month = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                allMonths.add(month);
            }

            // Converte para array e ordena do mais recente para o mais antigo
            const sortedMonths = Array.from(allMonths).sort((a, b) => b.localeCompare(a));
            
            // Preenche o dropdown
            sortedMonths.forEach(month => {
                const count = deliveriesByMonth[month] ? deliveriesByMonth[month].length : 0;
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${getMonthName(month)} (${count} entregas)`;
                monthFilter.appendChild(option);
            });

            // Mant√©m a sele√ß√£o atual
            if (currentMonthFilter !== 'all') {
                monthFilter.value = currentMonthFilter;
            }
        }

        // Fun√ß√£o para adicionar nova linha de entrega - CORRIGIDA
        function addNewRow() {
            const tableBody = document.getElementById('tableBody');
            const newRow = document.createElement('tr');
            
            // Cria um ID tempor√°rio √∫nico
            const tempId = 'temp-' + Date.now();
            newRow.setAttribute('data-id', tempId);
            
            newRow.innerHTML = `
                <td><input type="date" class="date-input" id="newDate-${tempId}"></td>
                <td><input type="text" id="newClient-${tempId}" placeholder="Nome do Cliente" class="required-field"></td>
                <td><input type="text" id="newResponsible-${tempId}" placeholder="Nome do Respons√°vel" class="required-field"></td>
                <td><input type="text" id="newResponsibleWhatsapp-${tempId}" placeholder="WhatsApp (DDD+N√∫mero)" class="required-field"></td>
                <td><input type="text" id="newDriver-${tempId}" placeholder="Nome Motorista" class="required-field"></td>
                <td><input type="text" id="newDriverWhatsapp-${tempId}" placeholder="WhatsApp (DDD+N√∫mero)" class="required-field"></td>
                <td><input type="text" id="newReceiver-${tempId}" placeholder="Nome do Recebedor" class="required-field"></td>
                <td><input type="text" id="newReceiverWhatsapp-${tempId}" placeholder="WhatsApp (DDD+N√∫mero)" class="required-field"></td>
                <td>
                    <select id="newCollaborator-${tempId}" class="required-field">
                        <option value="">Selecione</option>
                        ${collaborators.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" id="newOrigin-${tempId}" placeholder="Cidade/UF Origem" class="required-field"></td>
                <td><input type="text" id="newDestination-${tempId}" placeholder="Cidade/UF Destino" class="required-field"></td>
                <td><input type="text" id="newFreightValue-${tempId}" placeholder="Valor Frete (ex: 150,00)"></td>
                <td><input type="text" id="newCompanyValue-${tempId}" placeholder="Valor Empresa (ex: 100,00)"></td>
                <td>
                    <select id="newStatus-${tempId}" class="required-field">
                        <option value="coletando">Coletando</option>
                        <option value="transito">Em tr√¢nsito</option>
                        <option value="parado">Parado</option>
                        <option value="entregue">Entregue</option>
                    </select>
                </td>
                <td><input type="text" id="newObservation-${tempId}" placeholder="Observa√ß√£o"></td>
                <td>
                    <button class="action-btn" onclick="saveNewRow('${tempId}')">Salvar</button>
                    <button class="action-btn cancel-btn" onclick="cancelAdd('${tempId}')">Cancelar</button>
                </td>
            `;
            
            // Define a data atual como padr√£o
            const today = new Date().toISOString().split('T')[0];
            newRow.querySelector(`#newDate-${tempId}`).value = today;
            
            tableBody.prepend(newRow);
            
            // Foca no primeiro campo
            newRow.querySelector(`#newClient-${tempId}`).focus();
        }

        // Fun√ß√£o para salvar nova linha - CORRIGIDA
        function saveNewRow(tempId) {
            const row = document.querySelector(`tr[data-id="${tempId}"]`);
            if (!row) return;
            
            // Obt√©m todos os valores dos campos
            const deliveryData = {
                clientName: row.querySelector(`#newClient-${tempId}`).value.trim(),
                responsibleName: row.querySelector(`#newResponsible-${tempId}`).value.trim(),
                responsibleWhatsapp: row.querySelector(`#newResponsibleWhatsapp-${tempId}`).value.trim(),
                driverName: row.querySelector(`#newDriver-${tempId}`).value.trim(),
                driverWhatsapp: row.querySelector(`#newDriverWhatsapp-${tempId}`).value.trim(),
                receiverName: row.querySelector(`#newReceiver-${tempId}`).value.trim(),
                receiverWhatsapp: row.querySelector(`#newReceiverWhatsapp-${tempId}`).value.trim(),
                collaborator: row.querySelector(`#newCollaborator-${tempId}`).value,
                origin: row.querySelector(`#newOrigin-${tempId}`).value.trim(),
                destination: row.querySelector(`#newDestination-${tempId}`).value.trim(),
                freightValue: row.querySelector(`#newFreightValue-${tempId}`).value.trim(),
                companyValue: row.querySelector(`#newCompanyValue-${tempId}`).value.trim(),
                status: row.querySelector(`#newStatus-${tempId}`).value,
                observation: row.querySelector(`#newObservation-${tempId}`)?.value.trim() || '',
                createdAt: new Date(row.querySelector(`#newDate-${tempId}`).value).getTime() || Date.now()
            };
            
            // Valida√ß√£o dos campos obrigat√≥rios
            const requiredFields = [
                {field: 'clientName', name: 'Cliente'},
                {field: 'responsibleName', name: 'Respons√°vel'},
                {field: 'responsibleWhatsapp', name: 'WhatsApp do Respons√°vel'},
                {field: 'driverName', name: 'Motorista'},
                {field: 'driverWhatsapp', name: 'WhatsApp do Motorista'},
                {field: 'receiverName', name: 'Recebedor'},
                {field: 'receiverWhatsapp', name: 'WhatsApp do Recebedor'},
                {field: 'collaborator', name: 'Colaborador'},
                {field: 'origin', name: 'Origem'},
                {field: 'destination', name: 'Destino'}
            ];
            
            const missingFields = requiredFields.filter(f => !deliveryData[f.field]);
            
            if (missingFields.length > 0) {
                alert(`Por favor, preencha os seguintes campos obrigat√≥rios:\n${missingFields.map(f => f.name).join('\n')}`);
                return;
            }
            
            // Valida n√∫meros de WhatsApp
            const whatsappFields = [
                {field: 'responsibleWhatsapp', name: 'WhatsApp do Respons√°vel'},
                {field: 'driverWhatsapp', name: 'WhatsApp do Motorista'},
                {field: 'receiverWhatsapp', name: 'WhatsApp do Recebedor'}
            ];
            
            for (const field of whatsappFields) {
                const number = deliveryData[field.field].replace(/\D/g, '');
                if (number.length < 10 || number.length > 11) {
                    alert(`${field.name} inv√°lido! Deve conter DDD + n√∫mero (10 ou 11 d√≠gitos)`);
                    return;
                }
                deliveryData[field.field] = number;
            }
            
            // Formata os valores monet√°rios
            if (deliveryData.freightValue) {
                deliveryData.freightValue = parseFloat(deliveryData.freightValue.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            } else {
                deliveryData.freightValue = 0;
            }
            
            if (deliveryData.companyValue) {
                deliveryData.companyValue = parseFloat(deliveryData.companyValue.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            } else {
                deliveryData.companyValue = 0;
            }
            
            showLoading(true);
            
            // Salva no Firebase
            deliveriesRef.push(deliveryData)
                .then(() => {
                    showLoading(false);
                    row.remove();
                    window.scrollTo(0, 0); // Rolagem para o topo
                })
                .catch(error => {
                    console.error("Erro ao salvar entrega:", error);
                    showLoading(false);
                    alert("Erro ao salvar os dados. Por favor, tente novamente.");
                });
        }

        // Fun√ß√£o para cancelar a adi√ß√£o
        function cancelAdd(tempId) {
            const row = document.querySelector(`tr[data-id="${tempId}"]`);
            if (row) row.remove();
        }

        // Fun√ß√£o para aplicar todos os filtros combinados
        function applyCombinedFilter() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const driverFilter = document.getElementById('driverFilter').value;
            const collaboratorFilter = document.getElementById('collaboratorFilter').value;
            
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const rowId = rows[i].getAttribute('data-id');
                const delivery = deliveries[rowId];
                if (!delivery) continue;
                
                let shouldShow = true;
                
                // Filtro por m√™s
                if (currentMonthFilter !== 'all') {
                    const deliveryMonth = getMonthYear(delivery.createdAt || delivery.updatedAt);
                    shouldShow = deliveryMonth === currentMonthFilter;
                }
                
                // Filtro de texto geral
                if (searchText && shouldShow) {
                    const searchFields = [
                        delivery.clientName || '',
                        delivery.responsibleName || '',
                        delivery.driverName || '',
                        delivery.receiverName || '',
                        delivery.collaborator || '',
                        delivery.origin || '',
                        delivery.destination || '',
                        delivery.observation || '',
                        getStatusText(delivery.status || '')
                    ];
                    
                    shouldShow = searchFields.some(field => 
                        field.toLowerCase().includes(searchText)
                    );
                }
                
                // Filtro por status
                if (statusFilter && shouldShow) {
                    shouldShow = delivery.status === statusFilter;
                }
                
                // Filtro por motorista
                if (driverFilter && shouldShow) {
                    shouldShow = delivery.driverName === driverFilter;
                }
                
                // Filtro por colaborador
                if (collaboratorFilter && shouldShow) {
                    shouldShow = delivery.collaborator === collaboratorFilter;
                }
                
                rows[i].style.display = shouldShow ? '' : 'none';
            }
        }

        // Fun√ß√£o para carregar os dados do Firebase
        function loadData() {
            showLoading(true);
            deliveriesRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                deliveries = data;
                deliveriesByMonth = {};
                
                // Limpa a tabela
                document.getElementById('tableBody').innerHTML = '';
                
                // Processa cada entrega
                Object.keys(data).forEach(key => {
                    const delivery = data[key];
                    if (!delivery) return;
                    
                    // Adiciona √† tabela
                    addDeliveryToTable(key, delivery);
                    
                    // Agrupa por m√™s/ano
                    const monthYear = getMonthYear(delivery.createdAt || delivery.updatedAt);
                    if (monthYear) {
                        if (!deliveriesByMonth[monthYear]) {
                            deliveriesByMonth[monthYear] = [];
                        }
                        deliveriesByMonth[monthYear].push(delivery);
                    }
                });
                
                // Atualiza os filtros
                updateMonthFilters();
                updateDriverFilter();
                showLoading(false);
            }, (error) => {
                console.error("Erro ao carregar dados:", error);
                showLoading(false);
                alert("Erro ao carregar os dados. Por favor, recarregue a p√°gina.");
            });
        }

        // Fun√ß√£o para adicionar uma entrega √† tabela
        function addDeliveryToTable(id, delivery) {
            const tableBody = document.getElementById('tableBody');
            const row = document.createElement('tr');
            row.setAttribute('data-id', id);
            
            // Fun√ß√£o para formatar n√∫mero de WhatsApp
            const formatWhatsapp = (number) => {
                if (!number) return '-';
                const num = number.replace(/\D/g, '');
                return `<span class="whatsapp-number" title="Clique para copiar">${num}</span>`;
            };
            
            // Formata os valores monet√°rios
            const freightValue = delivery.freightValue ? parseFloat(delivery.freightValue).toFixed(2) : '';
            const companyValue = delivery.companyValue ? parseFloat(delivery.companyValue).toFixed(2) : '';
            
            row.innerHTML = `
                <td>${formatDate(delivery.createdAt)}</td>
                <td>${delivery.clientName || ''}</td>
                <td>${delivery.responsibleName || ''}</td>
                <td>${formatWhatsapp(delivery.responsibleWhatsapp)}</td>
                <td>${delivery.driverName || ''}</td>
                <td>${formatWhatsapp(delivery.driverWhatsapp)}</td>
                <td>${delivery.receiverName || ''}</td>
                <td>${formatWhatsapp(delivery.receiverWhatsapp)}</td>
                <td>${delivery.collaborator || ''}</td>
                <td>${delivery.origin || ''}</td>
                <td>${delivery.destination || ''}</td>
                <td>${freightValue ? 'R$ ' + freightValue : '-'}</td>
                <td>${companyValue ? 'R$ ' + companyValue : '-'}</td>
                <td class="status-${delivery.status || ''}">${getStatusText(delivery.status || '')}</td>
                <td>${delivery.observation || ''}</td>
                <td><button class="action-btn" onclick="editRow('${id}')">Editar</button></td>
            `;
            
            tableBody.appendChild(row);
            
            // Adiciona evento de clique para copiar n√∫mero
            row.querySelectorAll('.whatsapp-number').forEach(el => {
                el.addEventListener('click', function() {
                    const number = this.textContent;
                    navigator.clipboard.writeText(number).then(() => {
                        showCopyNotification();
                    }).catch(err => {
                        console.error('Erro ao copiar n√∫mero: ', err);
                    });
                });
            });
        }

        // Fun√ß√£o para obter o texto do status
        function getStatusText(status) {
            switch(status) {
                case 'coletando': return 'Coletando';
                case 'transito': return 'Em tr√¢nsito';
                case 'parado': return 'Parado';
                case 'entregue': return 'Entregue';
                default: return status;
            }
        }

        // Fun√ß√£o para resetar os filtros
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('driverFilter').value = '';
            document.getElementById('collaboratorFilter').value = '';
            document.getElementById('monthFilter').value = 'all';
            currentMonthFilter = 'all';
            applyCombinedFilter();
        }

        // Fun√ß√£o para editar uma linha existente
        function editRow(id) {
            const delivery = deliveries[id];
            if (!delivery) return;
            
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;
            
            // Formata a data para o input date
            const dateValue = delivery.createdAt ? new Date(delivery.createdAt).toISOString().split('T')[0] : '';
            
            // Formata os valores para exibi√ß√£o nos inputs
            const freightValue = delivery.freightValue ? delivery.freightValue.toFixed(2).replace('.', ',') : '';
            const companyValue = delivery.companyValue ? delivery.companyValue.toFixed(2).replace('.', ',') : '';
            
            row.innerHTML = `
                <td><input type="date" class="date-input" value="${dateValue}"></td>
                <td><input type="text" value="${delivery.clientName || ''}" class="required-field"></td>
                <td><input type="text" value="${delivery.responsibleName || ''}" class="required-field"></td>
                <td><input type="text" value="${delivery.responsibleWhatsapp || ''}" class="required-field"></td>
                <td><input type="text" value="${delivery.driverName || ''}" class="required-field"></td>
                <td><input type="text" value="${delivery.driverWhatsapp || ''}" class="required-field"></td>
                <td><input type="text" value="${delivery.receiverName || ''}" class="required-field"></td>
                <td><input type="text" value="${delivery.receiverWhatsapp || ''}" class="required-field"></td>
                <td>
                    <select class="required-field">
                        <option value="">Selecione</option>
                        ${collaborators.map(c => `<option value="${c}" ${c === delivery.collaborator ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" value="${delivery.origin || ''}" class="required-field"></td>
                <td><input type="text" value="${delivery.destination || ''}" class="required-field"></td>
                <td><input type="text" value="${freightValue}"></td>
                <td><input type="text" value="${companyValue}"></td>
                <td>
                    <select class="required-field">
                        <option value="coletando" ${delivery.status === 'coletando' ? 'selected' : ''}>Coletando</option>
                        <option value="transito" ${delivery.status === 'transito' ? 'selected' : ''}>Em tr√¢nsito</option>
                        <option value="parado" ${delivery.status === 'parado' ? 'selected' : ''}>Parado</option>
                        <option value="entregue" ${delivery.status === 'entregue' ? 'selected' : ''}>Entregue</option>
                    </select>
                </td>
                <td><input type="text" value="${delivery.observation || ''}"></td>
                <td>
                    <button class="action-btn" onclick="updateRow('${id}', this)">Atualizar</button>
                    <button class="action-btn delete-btn" onclick="deleteDelivery('${id}')">Excluir</button>
                    <button class="action-btn cancel-btn" onclick="cancelEdit('${id}')">Cancelar</button>
                </td>
            `;
            
            // Foca no primeiro campo
            row.querySelector('input[type="text"]').focus();
        }

        // Fun√ß√£o para atualizar uma linha existente
        function updateRow(id, button) {
            const row = button.parentNode.parentNode;
            const inputs = row.querySelectorAll("input");
            const selects = row.querySelectorAll("select");
            
            // Converte a data para timestamp
            const dateInput = inputs[0].value;
            const dateTimestamp = dateInput ? new Date(dateInput).getTime() : Date.now();
            
            const deliveryData = {
                clientName: inputs[1].value.trim(),
                responsibleName: inputs[2].value.trim(),
                responsibleWhatsapp: inputs[3].value.trim(),
                driverName: inputs[4].value.trim(),
                driverWhatsapp: inputs[5].value.trim(),
                receiverName: inputs[6].value.trim(),
                receiverWhatsapp: inputs[7].value.trim(),
                collaborator: selects[0].value,
                origin: inputs[8].value.trim(),
                destination: inputs[9].value.trim(),
                freightValue: inputs[10].value.trim(),
                companyValue: inputs[11].value.trim(),
                status: selects[1].value,
                observation: inputs[12]?.value.trim() || '',
                updatedAt: Date.now(),
                createdAt: dateTimestamp
            };
            
            // Valida√ß√£o dos campos obrigat√≥rios
            const requiredFields = [
                {field: 'clientName', name: 'Cliente'},
                {field: 'responsibleName', name: 'Respons√°vel'},
                {field: 'responsibleWhatsapp', name: 'WhatsApp do Respons√°vel'},
                {field: 'driverName', name: 'Motorista'},
                {field: 'driverWhatsapp', name: 'WhatsApp do Motorista'},
                {field: 'receiverName', name: 'Recebedor'},
                {field: 'receiverWhatsapp', name: 'WhatsApp do Recebedor'},
                {field: 'collaborator', name: 'Colaborador'},
                {field: 'origin', name: 'Origem'},
                {field: 'destination', name: 'Destino'}
            ];
            
            const missingFields = requiredFields.filter(f => !deliveryData[f.field]);
            
            if (missingFields.length > 0) {
                alert(`Por favor, preencha os seguintes campos obrigat√≥rios:\n${missingFields.map(f => f.name).join('\n')}`);
                return;
            }
            
            // Valida n√∫meros de WhatsApp
            const whatsappFields = [
                {field: 'responsibleWhatsapp', name: 'WhatsApp do Respons√°vel'},
                {field: 'driverWhatsapp', name: 'WhatsApp do Motorista'},
                {field: 'receiverWhatsapp', name: 'WhatsApp do Recebedor'}
            ];
            
            for (const field of whatsappFields) {
                const number = deliveryData[field.field].replace(/\D/g, '');
                if (number.length < 10 || number.length > 11) {
                    alert(`${field.name} inv√°lido! Deve conter DDD + n√∫mero (10 ou 11 d√≠gitos)`);
                    return;
                }
                deliveryData[field.field] = number;
            }
            
            // Formata os valores monet√°rios
            if (deliveryData.freightValue) {
                deliveryData.freightValue = parseFloat(deliveryData.freightValue.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            } else {
                deliveryData.freightValue = 0;
            }
            
            if (deliveryData.companyValue) {
                deliveryData.companyValue = parseFloat(deliveryData.companyValue.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            } else {
                deliveryData.companyValue = 0;
            }
            
            showLoading(true);
            
            // Atualiza no Firebase
            deliveriesRef.child(id).update(deliveryData)
                .then(() => {
                    showLoading(false);
                })
                .catch(error => {
                    console.error("Erro ao atualizar entrega:", error);
                    showLoading(false);
                    alert("Erro ao atualizar os dados. Por favor, tente novamente.");
                });
        }

        // Fun√ß√£o para excluir uma entrega
        function deleteDelivery(id) {
            if (!confirm("Tem certeza que deseja excluir esta entrega? Esta a√ß√£o n√£o pode ser desfeita.")) {
                return;
            }
            
            showLoading(true);
            deliveriesRef.child(id).remove()
                .then(() => {
                    showLoading(false);
                })
                .catch(error => {
                    console.error("Erro ao remover entrega:", error);
                    showLoading(false);
                    alert("Erro ao excluir a entrega. Por favor, tente novamente.");
                });
        }

        // Fun√ß√£o para cancelar edi√ß√£o
        function cancelEdit(id) {
            const delivery = deliveries[id];
            if (!delivery) return;
            
            addDeliveryToTable(id, delivery);
        }

        // Inicializa a aplica√ß√£o quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Adiciona evento de clique ao bot√£o de adicionar
            document.getElementById('addButton').addEventListener('click', addNewRow);
            
            // Adiciona eventos aos filtros
            document.getElementById('searchInput').addEventListener('input', applyCombinedFilter);
            document.getElementById('statusFilter').addEventListener('change', applyCombinedFilter);
            document.getElementById('driverFilter').addEventListener('change', applyCombinedFilter);
            document.getElementById('collaboratorFilter').addEventListener('change', applyCombinedFilter);
            document.getElementById('monthFilter').addEventListener('change', function() {
                currentMonthFilter = this.value;
                applyCombinedFilter();
            });
            
            // Carrega os dados do Firebase
            loadData();
        });
    </script>
</body>
</html>